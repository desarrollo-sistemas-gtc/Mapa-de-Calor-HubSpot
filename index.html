<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Mapa - Cluster por Agencia con filtros</title>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    #map {
      height: 100vh;
      width: 100%;
    }

    .controls-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1200;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      max-width: 320px;
      font-size: 13px;
      overflow: auto;
      max-height: 80vh;
    }

    .controls-panel h4 {
      margin: 4px 0 8px 0;
      font-size: 14px;
    }

    .controls-panel label {
      display: block;
      margin-top: 6px;
      font-weight: 600;
    }

    .controls-panel select,
    .controls-panel input[type="text"],
    .controls-panel button {
      width: 100%;
      box-sizing: border-box;
      margin-top: 6px;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .controls-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .controls-row button {
      flex: 1;
    }

    .legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1200;
      background: white;
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.15);
      max-height: 200px;
      overflow: auto;
      font-size: 13px;
    }

    .legend-item {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }

    .swatch {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .small {
      font-size: 12px;
      color: #555;
      margin-top: 6px;
    }

    /* multi select height */
    select[multiple] {
      height: 90px;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="controls-panel" id="controls">
    <h4>Filtros</h4>

    <label for="filter-agencia">Agencia</label>
    <select id="filter-agencia" multiple>
      <option value="__ALL__">— Todas —</option>
    </select>

    <label for="filter-pipeline">Pipeline</label>
    <select id="filter-pipeline" multiple>
      <option value="__ALL__">— Todos —</option>
    </select>

    <label for="filter-modelo">Modelo de interés CTC</label>
    <select id="filter-modelo" multiple>
      <option value="__ALL__">— Todos —</option>
    </select>

    <label for="filter-tipo">Tipo de solicitud de compra</label>
    <select id="filter-tipo" multiple>
      <option value="__ALL__">— Todos —</option>
    </select>

    <label for="search-text">Buscar (nombre negocio o código postal)</label>
    <input id="search-text" type="text" placeholder="Buscar..." />

    <div class="controls-row">
      <button id="btnApply">Aplicar</button>
      <button id="btnClear">Limpiar</button>
    </div>
    <div class="controls-row">
      <button id="btnHideAll">Ocultar todos</button>
      <button id="btnShowAll">Mostrar todos</button>
    </div>

    <div class="small" id="count-info">Registros cargados: 0 — Mostrando: 0</div>
  </div>

  <div class="legend" id="legend"></div>

  <script>
    // ------------------------
    // CONFIG Y UTILIDADES
    // ------------------------
    const map = L.map('map').setView([19.4326, -99.1332], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);

    function colorForString(str) {
      if (!str) str = 'sin';
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
        hash = hash & hash;
      }
      const h = Math.abs(hash) % 360;
      return `hsl(${h} 70% 45%)`;
    }
    function makeColoredIcon(color, labelText) {
      const label = labelText ? labelText[0].toUpperCase() : '';
      const html = `<div style="display:inline-block;width:22px;height:22px;border-radius:50%;border:2px solid rgba(255,255,255,0.85);box-shadow:0 1px 3px rgba(0,0,0,0.25);text-align:center;line-height:22px;font-weight:700;color:white;font-size:12px;background:${color}">${label}</div>`;
      return L.divIcon({ html, className: '', iconSize: [22, 22], iconAnchor: [11, 11], popupAnchor: [0, -11] });
    }
    function escapeHtml(text) { if (!text) return ''; return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
    function isEmptyVal(v) { return v == null || v === '' || String(v).toLowerCase() === 'none'; }

    // Rango lat/lon
    function isValidLat(n) { return typeof n === 'number' && !isNaN(n) && n >= -90 && n <= 90; }
    function isValidLon(n) { return typeof n === 'number' && !isNaN(n) && n >= -180 && n <= 180; }

    // columnas en el orden que diste
    const EXPECTED_COLS = ['id', 'dealname', 'agencia', 'codigo_postal', 'pipeline', 'cuenta_cliente', 'modelo_int_ctc', 'fecha_entrega', 'origen', 'suborigen', 'auto_version_n_pedido', 'tipo_solicitud_compra', 'cp', 'latitud', 'longitud'];

    // ------------------------
    // Estado global
    // ------------------------
    let recordsOriginal = [];   // todos los registros parseados
    let recordsFiltered = [];   // tras aplicar filtros
    let clustersByAgency = {};  // { agencia: {group,color} }
    let overlays = {};
    let allMarkerBounds = L.latLngBounds();

    // ------------------------
    // Cargar archivo (merge_data.txt)
    // ------------------------
    const cacheBuster = new Date().getTime();
    const sourceFile = `merged_data.txt?v=${cacheBuster}`; // Cambia ruta si es necesario

    fetch(sourceFile)
      .then(r => { if (!r.ok) throw new Error('Error al leer ' + sourceFile + ' : ' + r.status); return r.text(); })
      .then(text => {
        recordsOriginal = parseTextToRecords(text);
        buildFilterUI(recordsOriginal);
        applyFilters(); // render inicial sin filtros (todos)
      })
      .catch(err => { console.error('Error cargando datos:', err); alert('Error al cargar datos. Revisa consola.'); });

    // ------------------------
    // Parseo: convertir texto en array de objetos con llaves esperadas
    // ------------------------
    function parseTextToRecords(text) {
      const lines = text.split(/\r?\n/);
      const out = [];
      for (const raw of lines) {
        const line = raw.trim();
        if (!line) continue;
        const parts = line.split('|').map(p => p === '' ? null : p);

        // Si coincide con columnas completas (longitud >= EXPECTED_COLS.length) hago asignación por índice
        if (parts.length >= EXPECTED_COLS.length) {
          const obj = {};
          for (let i = 0; i < EXPECTED_COLS.length; i++) {
            obj[EXPECTED_COLS[i]] = parts[i] == null ? null : String(parts[i]).trim();
          }
          // lat/long convertir a number si posible
          obj.latitud = (obj.latitud != null && obj.latitud !== '') ? parseFloat(String(obj.latitud).replace(',', '.')) : null;
          obj.longitud = (obj.longitud != null && obj.longitud !== '') ? parseFloat(String(obj.longitud).replace(',', '.')) : null;

          // transformar 'None' a null y normalizar fecha
          for (const k in obj) { if (obj[k] != null && String(obj[k]).toLowerCase() === 'none') obj[k] = null; }
          out.push(obj);
          continue;
        }

        // Fallback robusto (buscar lat/lon numéricos en la línea)
        const numericCandidates = parts.map((p, idx) => {
          const v = p == null ? NaN : parseFloat(String(p).replace(',', '.'));
          return { idx, raw: p, value: v, isLat: isValidLat(v), isLon: isValidLon(v) };
        }).filter(x => !isNaN(x.value));

        let chosenLat = null, chosenLon = null;
        if (numericCandidates.length >= 2) {
          for (let i = numericCandidates.length - 2; i >= 0; i--) {
            const a = numericCandidates[i], b = numericCandidates[i + 1];
            if (isValidLat(a.value) && isValidLon(b.value)) { chosenLat = a.value; chosenLon = b.value; break; }
          }
          if (chosenLat == null) {
            const latC = numericCandidates.filter(c => c.isLat);
            const lonC = numericCandidates.filter(c => c.isLon);
            if (latC.length && lonC.length) {
              for (let i = latC.length - 1; i >= 0; i--) {
                for (let j = lonC.length - 1; j >= 0; j--) {
                  if (latC[i].idx < lonC[j].idx) { chosenLat = latC[i].value; chosenLon = lonC[j].value; break; }
                }
                if (chosenLat != null) break;
              }
            }
          }
        }
        if (chosenLat == null || chosenLon == null) {
          console.warn('Línea sin lat/lon válidos (omitida):', line);
          continue;
        }

        // Construir objeto con algunos campos por posición aproximada
        const obj = {
          id: parts[0] || null, dealname: parts[1] || null, agencia: null,
          codigo_postal: null, pipeline: null, cuenta_cliente: null,
          modelo_int_ctc: null, fecha_entrega: null, origen: null, suborigen: null,
          auto_version_n_pedido: null, tipo_solicitud_compra: null, cp: null,
          latitud: chosenLat, longitud: chosenLon
        };

        // intentemos rellenar agencia y cp buscando tokens que no sean numéricos y que parezcan CP
        // buscar cp de 4-5 digitos
        const postalToken = parts.find(p => p && /^\d{4,5}$/.test(String(p).trim()));
        if (postalToken) obj.codigo_postal = String(postalToken).trim();

        // agencia: primer token no numérico entre indices 2..(index of postal or index of first coord)
        const coordIdx = parts.map((p, i) => ({ i, v: p })).filter(x => {
          const v = x.v == null ? NaN : parseFloat(String(x.v).replace(',', '.'));
          return isValidLat(v) || isValidLon(v);
        }).map(x => x.i).sort((a, b) => a - b)[0] ?? parts.length - 1;

        for (let i = 2; i < Math.min(coordIdx, parts.length); i++) {
          const t = parts[i];
          if (t == null) continue;
          if (!/^\s*\d+\s*$/.test(String(t))) { obj.agencia = String(t).trim(); break; }
        }

        out.push(obj);
      } // end for lines
      console.info('Registros parseados:', out.length);
      return out;
    }

    // ------------------------
    // Construir UI de filtros (llenar selects con valores únicos)
    // ------------------------
    function buildFilterUI(records) {
      const agenciaSel = document.getElementById('filter-agencia');
      const pipelineSel = document.getElementById('filter-pipeline');
      const modeloSel = document.getElementById('filter-modelo');
      const tipoSel = document.getElementById('filter-tipo');

      function uniqValuesFor(key) {
        const s = new Set();
        records.forEach(r => {
          const v = r[key];
          if (isEmptyVal(v)) return;
          s.add(String(v).trim());
        });
        return Array.from(s).sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
      }

      // poblar selects
      agenciaSel.innerHTML = '<option value="__ALL__">— Todas —</option>';
      uniqValuesFor('agencia').forEach(a => agenciaSel.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`));

      pipelineSel.innerHTML = '<option value="__ALL__">— Todos —</option>';
      uniqValuesFor('pipeline').forEach(v => pipelineSel.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`));

      modeloSel.innerHTML = '<option value="__ALL__">— Todos —</option>';
      uniqValuesFor('modelo_int_ctc').forEach(v => modeloSel.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`));

      tipoSel.innerHTML = '<option value="__ALL__">— Todos —</option>';
      uniqValuesFor('tipo_solicitud_compra').forEach(v => tipoSel.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`));

      document.getElementById('btnApply').addEventListener('click', applyFilters);
      document.getElementById('btnClear').addEventListener('click', () => {
        agenciaSel.value = '__ALL__';
        pipelineSel.value = '__ALL__';
        modeloSel.value = '__ALL__';
        tipoSel.value = '__ALL__';
        document.getElementById('search-text').value = '';
        applyFilters();
      });

      document.getElementById('search-text').addEventListener('input', () => {
        clearTimeout(window._debounceTimer);
        window._debounceTimer = setTimeout(applyFilters, 350);
      });

      // Ocultar/mostrar todos los negocios
      document.getElementById('btnHideAll').addEventListener('click', () => {
        Object.values(clustersByAgency).forEach(({ group }) => { if (map.hasLayer(group)) map.removeLayer(group); });
        document.getElementById('count-info').textContent = `Registros cargados: ${recordsOriginal.length} — Mostrando: 0`;
        document.getElementById('legend').innerHTML = '<div class="small">Todos ocultos</div>';
      });
      document.getElementById('btnShowAll').addEventListener('click', () => {
        renderMarkers(recordsFiltered.length ? recordsFiltered : recordsOriginal);
        document.getElementById('count-info').textContent = `Registros cargados: ${recordsOriginal.length} — Mostrando: ${recordsFiltered.length || recordsOriginal.length}`;
      });
    }

    // ------------------------
    // Obtener valores seleccionados de un <select multiple>
    // ------------------------
    function getSelectedValues(selectEl) {
      const res = [];
      for (const opt of selectEl.options) if (opt.selected) res.push(opt.value);
      return res;
    }

    // ------------------------
    // Aplicar filtros y volver a renderizar
    // ------------------------
    function applyFilters() {
      const agenciaSel = document.getElementById('filter-agencia');
      const pipelineSel = document.getElementById('filter-pipeline');
      const modeloSel = document.getElementById('filter-modelo');
      const tipoSel = document.getElementById('filter-tipo');
      const agenciaVals = getSelectedValues(agenciaSel);
      const pipelineVals = getSelectedValues(pipelineSel);
      const modeloVals = getSelectedValues(modeloSel);
      const tipoVals = getSelectedValues(tipoSel);
      const searchText = (document.getElementById('search-text').value || '').trim().toLowerCase();

      recordsFiltered = recordsOriginal.filter(r => {
        if (!isValidLat(parseFloat(r.latitud)) || !isValidLon(parseFloat(r.longitud))) return false;
        if (!agenciaVals.includes('__ALL__') && !agenciaVals.includes(String(r.agencia).trim())) return false;
        if (!pipelineVals.includes('__ALL__') && !pipelineVals.includes(String(r.pipeline).trim())) return false;
        if (!modeloVals.includes('__ALL__') && !modeloVals.includes(String(r.modelo_int_ctc).trim())) return false;
        if (!tipoVals.includes('__ALL__') && !tipoVals.includes(String(r.tipo_solicitud_compra).trim())) return false;
        if (searchText) {
          const dn = isEmptyVal(r.dealname) ? '' : String(r.dealname).toLowerCase();
          const cp = isEmptyVal(r.codigo_postal) ? '' : String(r.codigo_postal).toLowerCase();
          if (!dn.includes(searchText) && !cp.includes(searchText)) return false;
        }
        return true;
      });

      renderMarkers(recordsFiltered);
      document.getElementById('count-info').textContent = `Registros cargados: ${recordsOriginal.length} — Mostrando: ${recordsFiltered.length}`;
    }

    // ------------------------
    // Renderizar marcadores agrupados por agencia
    // ------------------------
    function clearClusters() {
      // quitar grupos viejos del mapa
      Object.keys(clustersByAgency).forEach(ag => {
        const g = clustersByAgency[ag].group;
        if (map.hasLayer(g)) map.removeLayer(g);
      });
      clustersByAgency = {};
      overlays = {};
      allMarkerBounds = L.latLngBounds();
      // quitar control de capas previo (si existe) => no directo API; recreate control by keeping reference.
      // Simpler: remove existing layer control DOM node si existiera
      const existingControls = document.querySelectorAll('.leaflet-control-layers');
      existingControls.forEach(n => n.remove());
    }

    function renderMarkers(records) {
      clearClusters();

      // agrupar por agencia al tiempo que creamos clusters
      for (const r of records) {
        const agenciaKey = isEmptyVal(r.agencia) ? 'Sin Agencia' : String(r.agencia).trim();
        if (!clustersByAgency[agenciaKey]) {
          const color = colorForString(agenciaKey);
          const group = L.markerClusterGroup({
            chunkedLoading: true, spiderfyOnMaxZoom: true, showCoverageOnHover: false,
            iconCreateFunction: (cluster) => {
              const count = cluster.getChildCount();
              const size = count < 10 ? 36 : (count < 100 ? 44 : 52);
              const html = `<div style="width:${size}px;height:${size}px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:${color};color:white;font-weight:700;box-shadow:0 0 6px rgba(0,0,0,0.4);border:2px solid rgba(255,255,255,0.7)">${count}</div>`;
              return L.divIcon({ html, className: '', iconSize: [size, size], iconAnchor: [size / 2, size / 2] });
            }
          });
          clustersByAgency[agenciaKey] = { group, color };
          overlays[agenciaKey] = group;
        }

        const lat = parseFloat(r.latitud);
        const lon = parseFloat(r.longitud);
        if (!isValidLat(lat) || !isValidLon(lon)) continue;

        const { group, color } = clustersByAgency[agenciaKey];
        const icon = makeColoredIcon(color, agenciaKey);
        const popup = `<strong>${escapeHtml(r.dealname || '')}</strong><br/>Agencia: ${escapeHtml(agenciaKey)}<br/>CP: ${escapeHtml(r.cp || r.codigo_postal || '')}<br/>Modelo: ${escapeHtml(r.modelo_int_ctc || '')}<br/>Pipeline: ${escapeHtml(r.pipeline || '')}`;
        const marker = L.marker([lat, lon], { icon }).bindPopup(popup);
        group.addLayer(marker);
        allMarkerBounds.extend([lat, lon]);
      }

      // añadir grupos según default (todos por defecto)
      Object.keys(clustersByAgency).forEach(ag => {
        const { group } = clustersByAgency[ag];
        group.addTo(map);
      });

      // añadir control capas (recrear)
      const overlaysForControl = {}; Object.keys(overlays).forEach(k => overlaysForControl[k] = overlays[k]);
      L.control.layers(null, overlaysForControl, { collapsed: false, position: 'topright' }).addTo(map);

      // ajustar vista si hay puntos
      if (allMarkerBounds.isValid()) {
        map.fitBounds(allMarkerBounds, { padding: [40, 40] });
      }
      // reconstruir leyenda
      buildLegend();
    }

    // ------------------------
    // Leyenda simple
    // ------------------------
    function buildLegend() {
      const legendEl = document.getElementById('legend');
      legendEl.innerHTML = '';
      const agencies = Object.keys(clustersByAgency).sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
      if (agencies.length === 0) { legendEl.innerHTML = '<div class="small">No hay agencias visibles</div>'; return; }
      agencies.forEach(a => {
        const color = clustersByAgency[a].color || '#999';
        const node = document.createElement('div'); node.className = 'legend-item';
        node.innerHTML = `<div class="swatch" style="background:${color}"></div><div>${escapeHtml(a)}</div>`;
        legendEl.appendChild(node);
      });
    }

  </script>
</body>

</html>



<!-- Código original para reestablecer -->

<!--<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Calor</title>
   Evitar cache de la página 
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="index.css"/>
  <style>
    .custom-marker {
      background-color: #e74c3c;
      width: 25px;
      height: 41px;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      border: 2px solid #c0392b;
    }

    .custom-marker::after {
      content: '';
      width: 10px;
      height: 10px;
      background: white;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
  </style>
</head>

<body>
  <div id="map" style="height:900px;"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const country = "México";
    var map = L.map('map').setView([19.4326, -99.1332], 8); // Vista general de México
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const customIcon = L.divIcon({
      className: 'custom-marker',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34]
    });

    // Función para obtener coordenadas desde código postal y país
    async function geocode(postal, country) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&postalcode=${encodeURIComponent(postal)}&country=${encodeURIComponent(country)}`;
      const response = await fetch(url, { headers: { 'Accept-Language': 'es' } });
      const data = await response.json();
      if (data.length > 0) {
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      } else {
        console.warn("No se encontró ubicación para:", postal, country);
        return null;
      }
    }

    // Cache-busting: agregamos un timestamp a la URL
    const cacheBuster = new Date().getTime();

    // Leer locations.txt con cache dinámico
    fetch(`locations.txt?v=${cacheBuster}`)
      .then(response => response.text())
      .then(async text => {
        const lines = text.split('\n');
        for (const line of lines) {
          console.log("Procesando línea:", line);
          if (!line.trim()) continue;
          const [id, deal_name, postal, agencia, lat, long] = line.split('|');
          console.log("lat:", lat, "long:", long);
          const latNum = parseFloat(lat);
          const longNum = parseFloat(long);

          if (!isNaN(latNum) && !isNaN(longNum))
            L.marker([latNum, longNum], { icon: customIcon }).addTo(map).bindPopup(`${postal}, ${country}`);
        }
      })
      .catch(err => console.error(err));

      var latlngs = [[37, -109.05], [41, -109.03], [41, -102.05], [37, -102.04]];
      var polygon = L.polygon(latlngs, {color: 'red'}).addTo(map);
  </script>
</body>

</html> -->