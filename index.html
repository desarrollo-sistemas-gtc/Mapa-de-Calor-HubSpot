<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Calor</title>
  <!-- Evitar cache de la página -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div id="map" style="height:900px;"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const country = "México";
    var map = L.map('map').setView([19.4326, -99.1332], 8); // Vista general de México
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Función para obtener coordenadas desde código postal y país
    async function geocode(postal, country) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&postalcode=${encodeURIComponent(postal)}&country=${encodeURIComponent(country)}`;
      const response = await fetch(url, { headers: { 'Accept-Language': 'es' }});
      const data = await response.json();
      if(data.length > 0) {
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      } else {
        console.warn("No se encontró ubicación para:", postal, country);
        return null;
      }
    }

    // Cache-busting: agregamos un timestamp a la URL
    const cacheBuster = new Date().getTime();

    // Leer locations.txt con cache dinámico
    fetch(`locations.txt?v=${cacheBuster}`)
      .then(response => response.text())
      .then(async text => {
        const lines = text.split('\n');
        for(const line of lines) {
          console.log("Procesando línea:", line);
          if(!line.trim()) continue;
          const [id, deal_name, postal, agencia, lat, long] = line.split('|');
          console.log("lat:", lat, "long:", long);
          if(lat != null && long != null && lat !== '' && long !== '') {            
            let coords = [parseFloat(lat), parseFloat(long)];
            //const coords = await geocode(postal, country);
            if(coords) {
              L.marker(coords).addTo(map).bindPopup(`${postal}, ${country}`);
            }
          }
        }
      })
      .catch(err => console.error(err));
  </script>
</body>
</html>
